<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>


        <div class="container" style="margin-top: 64px; display: flex; justify-content: space-evenly;">
            <!-- led1 -->
            <div 
                class="dropdown" 
                id="led1" 
                style="    width: 300px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 1px solid #ccc;
                padding: 16px;
                border-radius: 8px;">
                <img 
                    src="./lightOn.gif"
                    style="width: 100px;"
                    class="light"
                >
                </img>
                <div style="display: flex; margin-top: 16px;">
                    <h2 style="margin-right: 16px;">Led 1</h2>
                    <button 
                        type="button" 
                        class="btn btn-primary dropdown-toggle option" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false" 
                        id="led1-options"
                    >
                        Options
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="led1Options">
                        <li class="btnOnLed"><a class="dropdown-item" href="#">Bật đèn</a></li>
                        <li class="btnOffLed"><a class="dropdown-item" href="#">Tắt đèn</a></li>
                        <li>
                            <a
                                class="dropdown-item"
                                href="#"
                                data-bs-target="#led1TimeOffModel"
                                data-bs-toggle="modal"
                                >Hẹn giờ tắt</a
                            >
                        </li>
                        <li>
                            <a
                                class="dropdown-item"
                                href="#"
                                data-bs-target="#led1TimeOnModel"
                                data-bs-toggle="modal"
                                >Hẹn giờ bật</a
                            >
                        </li>
                    </ul>
                </div>
                <div id="led1Counter" style="
                    border: 1px solid #ccc;
                    width: 100%;
                    margin-top: 16px;
                    padding: 0 16px;
                    border-radius: 8px;">
                </div>
                
    
            </div>
            <!-- led2 -->
            <div 
                class="dropdown" 
                id="led2" 
                style="    width: 300px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 1px solid #ccc;
                padding: 16px;
                border-radius: 8px;">
                <img 
                    src="./lightOn.gif"
                    style="width: 100px;"
                    class="light"
                >
                </img>
                <div style="display: flex; margin-top: 16px;">
                    <h2 style="margin-right: 16px;">Led 2</h2>
                    <button 
                        type="button" 
                        class="btn btn-primary dropdown-toggle option" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false" 
                        id="led2-options"
                    >
                        Options
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="led2Options">
                        <li class="btnOnLed"><a class="dropdown-item" href="#">Bật đèn</a></li>
                        <li class="btnOffLed"><a class="dropdown-item" href="#">Tắt đèn</a></li>
                        <li>
                            <a
                                class="dropdown-item"
                                href="#"
                                data-bs-target="#led2TimeOffModel"
                                data-bs-toggle="modal"
                                >Hẹn giờ tắt</a
                            >
                        </li>
                        <li>
                            <a
                                class="dropdown-item"
                                href="#"
                                data-bs-target="#led2TimeOnModel"
                                data-bs-toggle="modal"
                                >Hẹn giờ bật</a
                            >
                        </li>
                    </ul>
                </div>
                <div id="led2Counter" style="
                    border: 1px solid #ccc;
                    width: 100%;
                    margin-top: 16px;
                    padding: 0 16px;
                    border-radius: 8px;">
                </div>
            </div>
        </div>


        <!-- Modal Off 1-->
        <div
                class="modal fade"
                id="led1TimeOffModel"
                data-bs-backdrop="static"
                data-bs-keyboard="false"
                tabindex="-1"
                aria-labelledby="led1TimeOffModelLabel"
                aria-hidden="true"
            >
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Hẹn giờ tắt đèn 1</h5>
                    <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <label>Nhập thời gian tắt: </label>
                    <input type="datetime-local" class="ledDateOff" id="led1DateOff" />
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary ledBtnCloseOff"
                        data-bs-dismiss="modal"
                        id="led1BtnCloseOff"
                        >
                        Close
                        </button>
                        <button type="button" id="led1BtnSubmitOff" class="btn btn-primary ledBtnSubmitOff">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal On 1-->
        <div
            class="modal fade"
            id="led1TimeOnModel"
            data-bs-backdrop="static"
            data-bs-keyboard="false"
            tabindex="-1"
            aria-labelledby="led1TimeOnModelLabel"
            aria-hidden="true"
            >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hẹn giờ bật đèn 1</h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            >
                        </button>
                    </div>
                    <div class="modal-body">
                        <label>Nhập thời gian tắt: </label>
                        <input type="datetime-local" id="led1DateOn" class="ledDateOn" />
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary ledBtnCloseOn"
                            data-bs-dismiss="modal"
                            id="led1BtnCloseOn"
                            >
                            Close
                        </button>
                        <button type="button" id="led1BtnSubmitOn" class="btn btn-primary ledBtnSubmitOn">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal Off 2-->
        <div
                class="modal fade"
                id="led2TimeOffModel"
                data-bs-backdrop="static"
                data-bs-keyboard="false"
                tabindex="-1"
                aria-labelledby="led2TimeOffModelLabel"
                aria-hidden="true"
            >
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Hẹn giờ tắt đèn 2</h5>
                    <button
                    type="button"
                    class="btn-close ledBtnCloseOff"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <label>Nhập thời gian tắt: </label>
                    <input type="datetime-local" class="ledDateOff" id="led2DateOff" />
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary ledBtnCloseOff"
                        data-bs-dismiss="modal"
                        id="led2BtnCloseOff"
                        >
                        Close
                        </button>
                        <button type="button" id="led2BtnSubmitOff" class="btn btn-primary ledBtnSubmitOff">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal On 2-->
        <div
            class="modal fade"
            id="led2TimeOnModel"
            data-bs-backdrop="static"
            data-bs-keyboard="false"
            tabindex="-1"
            aria-labelledby="led2TimeOnModelLabel"
            aria-hidden="true"
            >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hẹn giờ bật đèn 2</h5>
                        <button
                            type="button"
                            class="btn-close ledBtnCloseOff"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            >
                        </button>
                    </div>
                    <div class="modal-body">
                        <label>Nhập thời gian tắt: </label>
                        <input type="datetime-local" id="led2DateOn" class="ledDateOn"/>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary ledBtnCloseOn"
                            data-bs-dismiss="modal"
                            id="led2BtnCloseOn"
                            >
                            Close
                        </button>
                        <button type="button" id="led2BtnSubmitOn" class="btn btn-primary ledBtnSubmitOn">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            function convertTimestampToCustom(time){
                const result = {
                    days: 0, hours: 0, minutes: 0, seconds: 0
                }

                result.days = Math.floor(time / (1000*60*60*24));
                result.hours = Math.floor((time / (1000*60*60)) % 24) 
                result.minutes = Math.floor((time / (1000*60)) % 60)
                result.seconds = Math.floor((time / (1000)) % 60)
                var string = "";
                if (result.days > 0) string += result.days + "d "
                if (result.hours > 0) string += result.hours + "h "
                if (result.minutes > 0) string += result.minutes + "m "
                if (result.seconds >= 0) string += result.seconds + "s "
                
                
                return string;
            }
            function itemCounter(id, type, timestamp){
                return `
                    <div style="margin: 12px 0; display: flex; justify-content: space-between; align-items: center;" id="${id}">
                        <div>
                            <h5>${type}</h4>
                            <span>Sau: </span>
                            <span class="timmer">${convertTimestampToCustom(timestamp)}</span>
                        </div>
                        <div>
                            <button type="button" class="btn-close cancel-timmer" aria-label="Close"></button>    
                        </div>
                    </div>`
            }   

            function handleCancelTimmer(counterContainer, timeout, timeInterval){
                
                counterContainer.querySelector(".cancel-timmer").onclick = function(){
                    this.parentElement.parentElement.remove()
                    clearTimeout(timeout)
                    clearInterval(timeInterval)
                }
            }

            function handleTurnOnLed(parent){
                const parentEle = document.querySelector(parent)
                const light1Ele = parentEle.querySelector(".light");
                light1Ele.setAttribute("src", "./lightOn.gif")
            }
            function handleTurnOffLed(parent){
                const parentEle = document.querySelector(parent)
                const light1Ele = parentEle.querySelector(".light");
                light1Ele.setAttribute("src", "./lightOff.gif")
            }
            function handleModelOffClick(parent, modelParent, counterParent){
                const modelOff = document.querySelector(modelParent);
                const dateOff = modelOff.querySelector(".ledDateOff");
                const btnCloseOff = modelOff.querySelector(".ledBtnCloseOff")
                const counter = document.querySelector(counterParent)
                
                const now = new Date();
                if (!dateOff.value){
                    alert("Bạn chưa chọn thời gian hẹn giờ.")
                    return;
                }

                const timer = new Date(dateOff.value);
                const temp = (timer - now) % 1000;
                const timestamp = (timer - now)
                if (timestamp <= 0) {
                    alert("Bạn cần đặt thời gian lớn hơn hiện tại");
                    // btnCloseOff.click()
                    return;
                }
                
                var tempTime = setTimeout(function(){


                    btnCloseOff.click()
                    var timeout = setTimeout(function (e) {
                        handleTurnOffLed(parent);
                        document.querySelector("#timer-" + timeout).remove()
                        clearInterval(timeInterval);
                    }, timestamp);

                    var newTimeStamp = timestamp;
                    counter.innerHTML = counter.innerHTML + itemCounter("timer-"+timeout, "Đèn tắt sau", newTimeStamp)
                    const timeInterval = setInterval(function () {
                        newTimeStamp -= 1000;
                        const timerContainerEle = document.querySelector("#timer-" + timeout)
                        timerContainerEle.querySelector(".timmer").textContent = convertTimestampToCustom(newTimeStamp)
                    }, 1000);
                    handleCancelTimmer(counter, timeout, timeInterval)
                }, (timestamp % 1000))
            }

            function handleModelOnClick(parent, modelParent, counterParent){
                const modelOn = document.querySelector(modelParent);
                const dateOn = modelOn.querySelector(".ledDateOn");
                const btnCloseOn = modelOn.querySelector(".ledBtnCloseOn")
                const counter = document.querySelector(counterParent)
                const now = new Date();
                if (!dateOn.value){
                    alert("Bạn chưa chọn thời gian hẹn giờ.")
                    return;
                }

                const timer = new Date(dateOn.value);
                const temp = (timer - now) % 1000;
                const timestamp = (timer - now)
                if (timestamp <= 0) {
                    alert("Bạn cần đặt thời gian lớn hơn hiện tại");
                    return;
                }
                
                var tempTime = setTimeout(function(){
                    var timeout = setTimeout(function (e) {
                        handleTurnOnLed(parent);
                        document.querySelector("#timer-" + timeout).remove()
                        clearInterval(timeInterval);
                    }, timestamp);

                    var newTimeStamp = timestamp;
                    counter.innerHTML = counter.innerHTML + itemCounter("timer-"+timeout, "Đèn bật sau", newTimeStamp)
                    const timeInterval = setInterval(function () {
                        newTimeStamp -= 1000;
                        const timerContainerEle = document.querySelector("#timer-" + timeout)
                        timerContainerEle.querySelector(".timmer").textContent = convertTimestampToCustom(newTimeStamp)
                    }, 1000);
                    handleCancelTimmer(counter, timeout, timeInterval)
                    btnCloseOn.click()
                }, (timestamp % 1000))
                
            }


            const led1Ele = document.querySelector("#led1")
            const turnOn1Ele = led1Ele.querySelector(".btnOnLed")
            const turnOff1Ele = led1Ele.querySelector(".btnOffLed")
            const btnSubmit1Off = document.querySelector("#led1BtnSubmitOff");
            const btnSubmit1On = document.querySelector("#led1BtnSubmitOn");

            turnOn1Ele.onclick = function(){
                handleTurnOnLed("#led1");
            }

            turnOff1Ele.onclick = function(){
                handleTurnOffLed("#led1");
            }
            btnSubmit1On.onclick = function(e){
                handleModelOnClick("#led1", "#led1TimeOnModel", "#led1Counter")
            };

            btnSubmit1Off.onclick = function(){
                handleModelOffClick("#led1", "#led1TimeOffModel", "#led1Counter")
            };


            const led2Ele = document.querySelector("#led2")
            const turnOn2Ele = led2Ele.querySelector(".btnOnLed")
            const turnOff2Ele = led2Ele.querySelector(".btnOffLed")
            const btnSubmit2Off = document.querySelector("#led2BtnSubmitOff");
            const btnSubmit2On = document.querySelector("#led2BtnSubmitOn");

            turnOn2Ele.onclick = function(){
                handleTurnOnLed("#led2");
            }

            turnOff2Ele.onclick = function(){
                handleTurnOffLed("#led2");
            }

            btnSubmit2On.onclick = function(){
                handleModelOnClick("#led2", "#led2TimeOnModel", "#led2Counter")
            };
            btnSubmit2Off.onclick = function(){
                handleModelOffClick("#led2", "#led2TimeOffModel", "#led2Counter")
            };
        })
    </script>
    </body>
</html>
